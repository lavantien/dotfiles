#!/usr/bin/env bash
# Universal git pre-commit hook - Auto-dectects OS and project type
# Supports: Windows (Git Bash, WSL) and Linux/macOS
# Languages: Go, Rust, C/C++, JavaScript/TypeScript, Python, C#, Java, Scala, PHP

set -e

# ============================================================================
# OS DETECTION
# ============================================================================
detect_os() {
    case "$(uname -s)" in
        Linux*)     echo "linux" ;;
        Darwin*)    echo "macos" ;;
        MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
        *)          echo "unknown" ;;
    esac
}

OS=$(detect_os)

# Colors (work in Git Bash, WSL, Linux)
if [ "$OS" = "windows" ]; then
    # Git Bash on Windows supports ANSI colors
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
fi

echo -e "${BLUE}Pre-commit checks...${NC}"

FAILED=0
PROJECT_ROOT=$(git rev-parse --show-toplevel)
cd "$PROJECT_ROOT"

# ============================================================================
# PROJECT TYPE DETECTION
# ============================================================================
detect_projects() {
    local types=()
    # Check from root
    [ -f "go.mod" ] && types+=("go")
    [ -f "Cargo.toml" ] && types+=("rust")
    [ -f "package.json" ] && types+=("node")
    [ -f "pyproject.toml" ] && types+=("python")
    [ -f "requirements.txt" ] && types+=("python")
    [ -f "setup.py" ] && types+=("python")
    [ -f "poetry.lock" ] && types+=("python")
    [ -n "$(find . -maxdepth 3 -name '*.cs' 2>/dev/null)" ] && types+=("csharp")
    [ -f "pom.xml" ] && types+=("java")
    [ -f "build.gradle" ] && types+=("java")
    [ -f "build.gradle.kts" ] && types+=("java")
    [ -f "build.sbt" ] && types+=("scala")
    [ -f "composer.json" ] && types+=("php")
    [ -f "Makefile" ] && ls *.c >/dev/null 2>&1 && types+=("c")
    [ -f "CMakeLists.txt" ] && types+=("cpp")
    [ -f "meson.build" ] && types+=("cpp")
    # Check common subdirectories
    [ -d "frontend" ] && [ -f "frontend/package.json" ] && types+=("node-frontend")
    [ -d "backend" ] && [ -n "$(find backend -maxdepth 3 -name '*.cs' 2>/dev/null)" ] && types+=("csharp-backend")
    echo "${types[@]}"
}

PROJECTS=($(detect_projects))
[ ${#PROJECTS[@]} -eq 0 ] && echo -e "${YELLOW}No recognized project type found.${NC}" && exit 0

# ============================================================================
# CROSS-PLATFORM COMMAND HELPERS
# ============================================================================
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# npx wrapper for cross-platform
npx_cmd() {
    if [ "$OS" = "windows" ]; then
        npx "$@" 2>/dev/null || ./node_modules/.bin/"$@" 2>/dev/null
    else
        npx "$@" 2>/dev/null || ./node_modules/.bin/"$@" 2>/dev/null
    fi
}

# ============================================================================
# LANGUAGE-SPECIFIC CHECKS
# ============================================================================

# === GO ===
run_go_checks() {
    echo -e "\n${YELLOW}=== Go ===${NC}"
    local staged=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
    [ -z "$staged" ] && return

    # Format: gofmt + goimports
    if command_exists goimports; then
        echo "Running goimports..."
        echo "$staged" | xargs goimports -w 2>/dev/null || true
    else
        echo "Running go fmt..."
        unformatted=$(gofmt -l $staged 2>/dev/null || true)
        [ -n "$unformatted" ] && echo "$unformatted" | xargs gofmt -w
    fi
    git add $staged 2>/dev/null || true

    # Lint: golangci-lint
    if command_exists golangci-lint; then
        echo "Running golangci-lint..."
        golangci-lint run --no-config ./... 2>/dev/null || echo -e "${YELLOW}Lint warnings found.${NC}"
    fi

    # Type check: go vet
    echo "Running go vet..."
    go vet ./... 2>/dev/null || echo -e "${YELLOW}Go vet found issues.${NC}"
}

# === RUST ===
run_rust_checks() {
    echo -e "\n${YELLOW}=== Rust ===${NC}"
    local staged=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' | head -20 || true)
    [ -z "$staged" ] && return

    # Format: cargo fmt
    echo "Running cargo fmt..."
    if ! cargo fmt --check 2>/dev/null; then
        cargo fmt
        git add $staged 2>/dev/null || true
        echo -e "${YELLOW}Files formatted. Please review.${NC}"
    fi

    # Lint: cargo clippy
    echo "Running cargo clippy..."
    cargo clippy --quiet -- -D warnings 2>/dev/null || echo -e "${YELLOW}Clippy warnings found.${NC}"

    # Type check: cargo check
    cargo check 2>/dev/null || {
        echo -e "${RED}Cargo check failed.${NC}"
        FAILED=1
    }
}

# === C/C++ ===
run_c_checks() {
    echo -e "\n${YELLOW}=== C/C++ ===${NC}"
    local staged=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h|cpp|hpp|cc|cxx)$' || true)
    [ -z "$staged" ] && return

    # Format: clang-format
    if command_exists clang-format; then
        echo "Running clang-format..."
        for f in $staged; do
            [ -f "$f" ] && clang-format -i "$f" 2>/dev/null && git add "$f"
        done
    fi

    # Lint: clang-tidy
    if command_exists clang-tidy && [ -f "compile_commands.json" ]; then
        echo "Running clang-tidy..."
        for f in $staged; do
            [ -f "$f" ] && clang-tidy "$f" 2>/dev/null || true
        done
    fi

    # Lint: cppcheck
    if command_exists cppcheck; then
        echo "Running cppcheck..."
        cppcheck --enable=all --error-exitcode=1 $staged 2>/dev/null || echo -e "${YELLOW}Cppcheck warnings.${NC}"
    fi
}

# === JAVASCRIPT/TYPESCRIPT ===
run_node_checks() {
    echo -e "\n${YELLOW}=== JavaScript/TypeScript ===${NC}"

    # Format: Prettier
    if npx prettier --version &>/dev/null 2>&1 || [ -f "node_modules/.bin/prettier" ]; then
        echo "Running Prettier..."
        # Only use svelte plugin if actually installed
        if [ -f "node_modules/prettier-plugin-svelte/index.js" ] || [ -f "node_modules/prettier-plugin-svelte/dist/index.js" ]; then
            prettier_args="--plugin=prettier-plugin-svelte"
        else
            prettier_args=""
        fi
        if ! npx prettier --check . $prettier_args >/dev/null 2>&1; then
            npx prettier --write . $prettier_args 2>&1 | head -5
            git add . 2>/dev/null || true
            echo -e "${YELLOW}Files formatted with Prettier.${NC}"
        fi
    fi

    # Lint: ESLint
    if npx eslint --version &>/dev/null 2>&1 || [ -f "node_modules/.bin/eslint" ]; then
        echo "Running ESLint..."
        if ! npx eslint . 2>&1 | head -20; then
            echo -e "${RED}ESLint errors found.${NC}"
            FAILED=1
        fi
    fi

    # Type check: tsc / svelte-check
    if grep -q '"check"' package.json 2>/dev/null; then
        echo "Running type check..."
        if ! npm run check --silent 2>/dev/null; then
            echo -e "${RED}Type check failed.${NC}"
            FAILED=1
        fi
    elif npx tsc --version &>/dev/null 2>&1 && [ -f "tsconfig.json" ]; then
        echo "Running tsc..."
        npx tsc --noEmit 2>/dev/null || echo -e "${YELLOW}TypeScript errors found.${NC}"
    fi
}

# === PYTHON ===
run_python_checks() {
    echo -e "\n${YELLOW}=== Python ===${NC}"
    local staged=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$|pyproject\.toml' || true)
    [ -z "$staged" ] && return

    # Format/Lint: ruff (recommended - replaces black, isort, flake8)
    if command_exists ruff; then
        echo "Running ruff format..."
        ruff format --check $staged 2>/dev/null || {
            ruff format $staged
            git add $staged 2>/dev/null || true
        }

        echo "Running ruff check..."
        ruff check $staged 2>/dev/null || ruff check --fix $staged 2>/dev/null || FAILED=1
    fi

    # Format: black (fallback)
    if ! command_exists ruff; then
        if command_exists black; then
            echo "Running black..."
            black --check $staged 2>/dev/null || {
                black $staged
                git add $staged 2>/dev/null || true
            }
        fi

        # Import sort: isort
        if command_exists isort; then
            echo "Running isort..."
            isort --check-only $staged 2>/dev/null || {
                isort $staged
                git add $staged 2>/dev/null || true
            }
        fi
    fi

    # Type check: mypy
    if command_exists mypy; then
        echo "Running mypy..."
        mypy $staged 2>/dev/null || echo -e "${YELLOW}Type check warnings.${NC}"
    fi
}

# === C# ===
run_csharp_checks() {
    echo -e "\n${YELLOW}=== C# ===${NC}"
    local staged=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cs|csproj)$' || true)
    [ -z "$staged" ] && return

    if ! command_exists dotnet; then
        return
    fi

    # Find solution or project files
    local sln=$(find . -maxdepth 3 -name '*.sln' 2>/dev/null | head -1)

    # Format: dotnet format
    echo "Running dotnet format..."
    if [ -n "$sln" ]; then
        dotnet format "$sln" 2>/dev/null || true
    else
        find . -name '*.csproj' -exec dotnet format {} \; 2>/dev/null || true
    fi
    git add backend/ src/ *.csproj 2>/dev/null || true

    # Type check: dotnet build
    if [ -n "$sln" ]; then
        dotnet build "$sln" --no-restore 2>/dev/null || {
            echo -e "${RED}Dotnet build failed.${NC}"
            FAILED=1
        }
    fi
}

# === JAVA ===
run_java_checks() {
    echo -e "\n${YELLOW}=== Java ===${NC}"

    # Format: spotless
    if [ -f "pom.xml" ] && grep -q "spotless" pom.xml 2>/dev/null; then
        echo "Running spotless check..."
        mvn spotless:check 2>/dev/null || {
            mvn spotless:apply 2>/dev/null
            git add . 2>/dev/null || true
        }
    fi

    # Format: google-java-format
    if command_exists google-java-format; then
        echo "Running google-java-format..."
        google-java-format --replace 2>/dev/null || true
    fi

    # Lint: checkstyle
    if [ -f "pom.xml" ] && command_exists mvn; then
        echo "Running checkstyle..."
        mvn checkstyle:check 2>/dev/null || echo -e "${YELLOW}Checkstyle warnings.${NC}"
    fi
}

# === SCALA ===
run_scala_checks() {
    echo -e "\n${YELLOW}=== Scala ===${NC}"

    # Format: scalafmt
    if command_exists scalafmt; then
        echo "Running scalafmt..."
        scalafmt --non-interactive 2>/dev/null || true
    fi

    # Type check/Lint: scalac
    if [ -f "build.sbt" ] && command_exists sbt; then
        echo "Running sbt compile..."
        sbt compile 2>/dev/null || echo -e "${YELLOW}Compilation warnings.${NC}"
    fi
}

# === PHP ===
run_php_checks() {
    echo -e "\n${YELLOW}=== PHP ===${NC}"
    local staged=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.php$' || true)
    [ -z "$staged" ] && return

    # Format: Laravel Pint
    if [ -f "vendor/bin/pint" ]; then
        echo "Running Laravel Pint..."
        ./vendor/bin/pint --test 2>/dev/null || {
            ./vendor/bin/pint
            git add $staged 2>/dev/null || true
        }
    fi

    # Format: php-cs-fixer
    if [ -f "vendor/bin/php-cs-fixer" ]; then
        echo "Running php-cs-fixer..."
        ./vendor/bin/php-cs-fixer fix --dry-run 2>/dev/null || {
            ./vendor/bin/php-cs-fixer fix
            git add $staged 2>/dev/null || true
        }
    fi

    # Type check/Lint: PHPStan
    if [ -f "vendor/bin/phpstan" ]; then
        echo "Running PHPStan..."
        ./vendor/bin/phpstan analyse --memory-limit=1G 2>/dev/null || echo -e "${YELLOW}PHPStan warnings.${NC}"
    fi

    # Type check: Psalm
    if [ -f "vendor/bin/psalm" ]; then
        echo "Running Psalm..."
        ./vendor/bin/psalm --show-info=false 2>/dev/null || echo -e "${YELLOW}Psalm warnings.${NC}"
    fi
}

# ============================================================================
# RUN CHECKS FOR DETECTED PROJECTS
# ============================================================================
for project in "${PROJECTS[@]}"; do
    case $project in
        go) run_go_checks ;;
        rust) run_rust_checks ;;
        c) run_c_checks ;;
        cpp) run_c_checks ;;
        node|node-frontend) cd frontend 2>/dev/null || cd .; run_node_checks; cd "$PROJECT_ROOT" ;;
        python) run_python_checks ;;
        csharp|csharp-backend) cd backend 2>/dev/null || cd .; run_csharp_checks; cd "$PROJECT_ROOT" ;;
        java) run_java_checks ;;
        scala) run_scala_checks ;;
        php) run_php_checks ;;
    esac
done

# ============================================================================
# RESULT
# ============================================================================
if [ $FAILED -eq 1 ]; then
    echo -e "\n${RED}Pre-commit checks failed. Fix issues or use --no-verify to bypass.${NC}"
    exit 1
fi

echo -e "${GREEN}All checks passed!${NC}"
exit 0
